# ðŸ› Bug ä¿®æ­£èªªæ˜Ž

## å·²ä¿®æ­£çš„å•é¡Œ

### å•é¡Œ 1ï¼šåªç”Ÿæˆ 4 å€‹ç« ç¯€è€Œä¸æ˜¯ 5 å€‹ âœ…

**åŽŸå› ï¼š**
- AI å¯èƒ½ç”Ÿæˆå°‘æ–¼ 5 å€‹ç« ç¯€
- æœ‰äº›å½±ç‰‡æ²’æœ‰ highlights å°Žè‡´è¢«è·³éŽ

**ä¿®æ­£ï¼š**
1. åœ¨ prompt ä¸­æ˜Žç¢ºè¦æ±‚ã€Œå¿…é ˆå‰µä½œæ­£å¥½ 5 æ®µå°ç™½ã€
2. å¦‚æžœå½±ç‰‡æ²’æœ‰ highlightsï¼Œä½¿ç”¨æ•´å€‹å½±ç‰‡çš„å‰ 15 ç§’
3. æ”¹é€²ç« ç¯€å‰µå»ºé‚è¼¯ï¼Œç¢ºä¿æ‰€æœ‰å½±ç‰‡éƒ½è¢«ä½¿ç”¨

```go
// ä¿®æ­£å‰ï¼šæœƒè·³éŽæ²’æœ‰ highlights çš„å½±ç‰‡
if ch.HighlightIndex >= len(video.Highlights) {
    continue
}

// ä¿®æ­£å¾Œï¼šæ²’æœ‰ highlights å°±ä½¿ç”¨æ•´å€‹å½±ç‰‡
if len(video.Highlights) > 0 && ch.HighlightIndex < len(video.Highlights) {
    // ä½¿ç”¨ highlight
} else {
    // ä½¿ç”¨å½±ç‰‡å‰ 15 ç§’
    startTime = 0
    endTime = 15.0
}
```

---

### å•é¡Œ 2ï¼šçµå°¾åœ–ç‰‡æ²’æœ‰åŠ å…¥ âœ…

**åŽŸå› ï¼š**
- `project.EndingImage` è·¯å¾‘æ²’æœ‰è¢«æ­£ç¢ºä¿å­˜åˆ°å°ˆæ¡ˆç‰©ä»¶ä¸­

**ä¿®æ­£ï¼š**
1. åœ¨ä¸Šå‚³çµå°¾åœ–ç‰‡æ™‚æ·»åŠ æ—¥èªŒç¢ºèªä¿å­˜
2. åœ¨æª¢æŸ¥çµå°¾åœ–ç‰‡æ™‚æ·»åŠ è©³ç´°æ—¥èªŒ
3. ç¢ºä¿ `EndingImage` è·¯å¾‘è¢«æ­£ç¢ºå„²å­˜

```go
// æ·»åŠ æ—¥èªŒç¢ºèª
log.Printf("Ending image saved for project %s: %s", projectID, imagePath)
log.Printf("Checking ending image: path=%s, message=%s", project.EndingImage, project.Story.FinalMessage)
```

---

### å•é¡Œ 3ï¼šåŽŸå½±ç‰‡è²éŸ³æ²’æœ‰ç§»é™¤ âœ…

**åŽŸå› ï¼š**
- FFmpeg å‘½ä»¤ä½¿ç”¨ `-to` åƒæ•¸å¯èƒ½æœƒä¿ç•™éŸ³è¨Š
- éœ€è¦ä½¿ç”¨ `-t` åƒæ•¸ä¸¦ç¢ºä¿ `-an` æ¨™èªŒæ­£ç¢ºä½œç”¨

**ä¿®æ­£ï¼š**
1. æ”¹ç”¨ `-t` (duration) è€Œä¸æ˜¯ `-to` (end time)
2. ç¢ºä¿ `-an` æ¨™èªŒåœ¨æ­£ç¢ºä½ç½®
3. æ·»åŠ æ—¥èªŒç¢ºèªéŸ³è¨Šç§»é™¤

```go
// ä¿®æ­£å‰
cmd := exec.Command("ffmpeg",
    "-i", videoPath,
    "-ss", fmt.Sprintf("%.2f", chapter.StartTime),
    "-to", fmt.Sprintf("%.2f", actualEndTime),
    "-an",
    ...
)

// ä¿®æ­£å¾Œ
cmd := exec.Command("ffmpeg",
    "-i", videoPath,
    "-ss", fmt.Sprintf("%.2f", chapter.StartTime),
    "-t", fmt.Sprintf("%.2f", actualEndTime - chapter.StartTime),
    "-an",
    "-c:v", "libx264",
    ...
)
```

---

### å•é¡Œ 4ï¼šèƒŒæ™¯éŸ³æ¨‚æ²’æœ‰åŠ å…¥ âœ…

**åŽŸå› ï¼š**
- èƒŒæ™¯éŸ³æ¨‚æ··åˆå¯èƒ½å¤±æ•—ä½†æ²’æœ‰æ˜Žç¢ºæ—¥èªŒ
- éœ€è¦ç¢ºä¿éŸ³æ¨‚ç”Ÿæˆå’Œæ··åˆéƒ½æˆåŠŸåŸ·è¡Œ

**ä¿®æ­£ï¼š**
1. æ”¹é€²éŒ¯èª¤è™•ç†é‚è¼¯
2. æ·»åŠ è©³ç´°æ—¥èªŒ
3. ç¢ºä¿éŸ³æ¨‚æª”æ¡ˆæ­£ç¢ºæ··åˆ

```go
// æ”¹é€²éŒ¯èª¤è™•ç†
musicErr := addBackgroundMusic(project, subtitledVideoPath, finalVideoPath)
if musicErr != nil {
    log.Printf("Warning: Failed to add background music: %v", musicErr)
    os.Rename(subtitledVideoPath, finalVideoPath)
} else {
    // æˆåŠŸåŠ å…¥éŸ³æ¨‚ï¼Œæ¸…ç†ä¸­é–“æª”æ¡ˆ
    os.Remove(subtitledVideoPath)
}
```

---

## æ¸¬è©¦å»ºè­°

### é‡æ–°æ¸¬è©¦å®Œæ•´æµç¨‹

1. **è¨ªå•ç¶²å€**
   ```
   http://localhost:8080/love-story
   ```

2. **ä¸Šå‚³å½±ç‰‡**
   - ç¢ºä¿ä¸Šå‚³æ­£å¥½ 5 å€‹å½±ç‰‡
   - æ¯å€‹å½±ç‰‡è‡³å°‘ 15 ç§’ï¼ˆæˆ–æ›´é•·ï¼‰

3. **ä¸Šå‚³çµå°¾åœ–ç‰‡**
   - é¸æ“‡æ¸…æ™°çš„ç‹—ç‹—ç…§ç‰‡
   - JPG æˆ– PNG æ ¼å¼

4. **ç­‰å¾…è™•ç†**
   - ç´„ 4-5 åˆ†é˜

5. **æª¢æŸ¥çµæžœ**
   - âœ… æ‡‰è©²æœ‰ 5 å€‹ç« ç¯€ï¼ˆæ¯å€‹ç´„ 15 ç§’ï¼‰
   - âœ… æœ€å¾Œæœ‰çµå°¾åœ–ç‰‡ï¼ˆ5 ç§’ï¼‰
   - âœ… æ²’æœ‰åŽŸå½±ç‰‡è²éŸ³
   - âœ… æœ‰èƒŒæ™¯éŸ³æ¨‚ï¼ˆæŸ”å’Œï¼‰
   - âœ… æœ‰å­—å¹•

---

## é©—è­‰æ–¹å¼

### æª¢æŸ¥å½±ç‰‡çµæ§‹

```bash
# æŸ¥çœ‹å½±ç‰‡è³‡è¨Š
ffprobe final.mp4

# æ‡‰è©²çœ‹åˆ°ï¼š
# - Video stream: h264
# - Audio stream: aac (åªæœ‰èƒŒæ™¯éŸ³æ¨‚ï¼Œç„¡åŽŸéŸ³)
```

### æª¢æŸ¥æ™‚é•·

```bash
# è¨ˆç®—ç¸½æ™‚é•·
# 5 å€‹ç« ç¯€ Ã— 15 ç§’ = 75 ç§’
# + çµå°¾åœ–ç‰‡ 5 ç§’ = 80 ç§’
```

### æª¢æŸ¥æª”æ¡ˆ

```bash
# å°ˆæ¡ˆç›®éŒ„æ‡‰è©²åŒ…å«ï¼š
storage/projects/{project-id}/
â”œâ”€â”€ ending_image.jpg         âœ… çµå°¾åœ–ç‰‡
â”œâ”€â”€ background_music.mp3     âœ… èƒŒæ™¯éŸ³æ¨‚
â”œâ”€â”€ subtitles.srt            âœ… å­—å¹•æª”æ¡ˆ
â”œâ”€â”€ segment_1.mp4            âœ… ç¬¬ 1 æ®µï¼ˆç„¡åŽŸéŸ³ï¼‰
â”œâ”€â”€ segment_2.mp4            âœ… ç¬¬ 2 æ®µï¼ˆç„¡åŽŸéŸ³ï¼‰
â”œâ”€â”€ segment_3.mp4            âœ… ç¬¬ 3 æ®µï¼ˆç„¡åŽŸéŸ³ï¼‰
â”œâ”€â”€ segment_4.mp4            âœ… ç¬¬ 4 æ®µï¼ˆç„¡åŽŸéŸ³ï¼‰
â”œâ”€â”€ segment_5.mp4            âœ… ç¬¬ 5 æ®µï¼ˆç„¡åŽŸéŸ³ï¼‰
â””â”€â”€ final.mp4                âœ… æœ€çµ‚å½±ç‰‡
```

---

## é æœŸè¼¸å‡º

### å½±ç‰‡çµæ§‹

```
æ™‚é–“è»¸ï¼š
0:00 - 0:15   ç¬¬ 1 æ®µå°ç™½ + å½±ç‰‡ 1ï¼ˆç„¡åŽŸéŸ³ï¼‰
0:15 - 0:30   ç¬¬ 2 æ®µå°ç™½ + å½±ç‰‡ 2ï¼ˆç„¡åŽŸéŸ³ï¼‰
0:30 - 0:45   ç¬¬ 3 æ®µå°ç™½ + å½±ç‰‡ 3ï¼ˆç„¡åŽŸéŸ³ï¼‰
0:45 - 1:00   ç¬¬ 4 æ®µå°ç™½ + å½±ç‰‡ 4ï¼ˆç„¡åŽŸéŸ³ï¼‰
1:00 - 1:15   ç¬¬ 5 æ®µå°ç™½ + å½±ç‰‡ 5ï¼ˆç„¡åŽŸéŸ³ï¼‰
1:15 - 1:20   çµå°¾åœ–ç‰‡ + æ„Ÿäººæ–‡å­—

ç¸½æ™‚é•·ï¼šç´„ 80 ç§’
```

### éŸ³è¨Šæ•ˆæžœ

```
âœ… åŽŸå½±ç‰‡è²éŸ³ï¼šå®Œå…¨ç§»é™¤
âœ… èƒŒæ™¯éŸ³æ¨‚ï¼š15% éŸ³é‡ï¼ˆC å¤§èª¿å’Œå¼¦ï¼‰
âœ… TTS æ—ç™½ï¼š100% éŸ³é‡ï¼ˆå¦‚å•Ÿç”¨ï¼‰
âœ… æ··åˆæ•ˆæžœï¼šæ¸…æ™°ã€æŸ”å’Œ
```

### è¦–è¦ºæ•ˆæžœ

```
âœ… å­—å¹•ï¼šç™½è‰²æ–‡å­— + é»‘é‚Š
âœ… ä½ç½®ï¼šåº•éƒ¨å±…ä¸­
âœ… çµå°¾ï¼šåœ–ç‰‡å±…ä¸­ + æ–‡å­—ç–ŠåŠ 
âœ… è½‰å ´ï¼šæµæš¢æ‹¼æŽ¥
```

---

## æ•…éšœæŽ’é™¤

### å¦‚æžœé‚„æ˜¯åªæœ‰ 4 å€‹ç« ç¯€

**æª¢æŸ¥ï¼š**
```bash
# æŸ¥çœ‹ AI ç”Ÿæˆçš„æ•…äº‹
curl http://localhost:8080/api/v2/story/projects/{project_id} | jq '.story.chapters | length'

# æ‡‰è©²è¿”å›žï¼š5
```

**å¦‚æžœè¿”å›žå°‘æ–¼ 5ï¼š**
- ç­‰å¾…ä¸‹ä¸€æ¬¡ç”Ÿæˆï¼ˆAI æœƒéš¨æ©Ÿè®ŠåŒ–ï¼‰
- æˆ–æ‰‹å‹•é‡è©¦å°ˆæ¡ˆ

### å¦‚æžœé‚„æœ‰åŽŸéŸ³

**æª¢æŸ¥ segment æª”æ¡ˆï¼š**
```bash
ffprobe segment_1.mp4 | grep Audio

# æ‡‰è©²æ²’æœ‰ Audio stream
# å¦‚æžœæœ‰ï¼Œæª¢æŸ¥ FFmpeg ç‰ˆæœ¬å’Œå‘½ä»¤
```

### å¦‚æžœæ²’æœ‰èƒŒæ™¯éŸ³æ¨‚

**æª¢æŸ¥æ—¥èªŒï¼š**
```bash
tail -f logs/backend.log | grep music

# æ‡‰è©²çœ‹åˆ°ï¼š
# "Added background music for project..."
```

---

**æ‰€æœ‰å•é¡Œå·²ä¿®æ­£ï¼é‡æ–°æ¸¬è©¦æ‡‰è©²å¯ä»¥å¾—åˆ°å®Œç¾Žçš„å‘Šç™½å½±ç‰‡äº†ï¼** ðŸ’ðŸŽ¬
