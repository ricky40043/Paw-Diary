# =============================================================================
# Render Blueprint - Infrastructure as Code
# https://render.com/docs/blueprint-spec
# =============================================================================

services:
  - type: web
    name: paw-diary
    runtime: go

    region: singapore
    plan: free
    autoDeploy: true

    buildCommand: |
      set -e
      # Install ffmpeg (static build, avoid apt on read-only FS)
      curl -L https://johnvansickle.com/ffmpeg/releases/ffmpeg-release-amd64-static.tar.xz -o /tmp/ffmpeg.tar.xz
      tar -xJf /tmp/ffmpeg.tar.xz -C /tmp
      FFDIR=$(tar -tf /tmp/ffmpeg.tar.xz | head -1 | cut -d/ -f1)
      cp /tmp/$FFDIR/ffmpeg /tmp/$FFDIR/ffprobe /usr/local/bin/
      chmod +x /usr/local/bin/ffmpeg /usr/local/bin/ffprobe

      npm install --prefix frontend
      npm run build --prefix frontend
      go build -o main .

    startCommand: ./main

    envVars:
      - key: PORT
        value: 8080
      - key: STORAGE_PATH
        value: ./storage
      - key: AI_API_KEY
        sync: false  # Must be set manually in Render Dashboard (secret)
      - key: AI_API_ENDPOINT
        value: https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent

    healthCheckPath: /api/health
